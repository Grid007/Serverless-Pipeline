AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template for deploying Lambda functions, ECS Fargate, and a Step Function via CodePipeline.

Parameters:
  CodeBucket:
    Type: String
    Description: "The S3 bucket containing the deployment packages"
  ValidatorCodeKey:
    Type: String
    Description: "The S3 key for the ValidatorLambda deployment package"
  DataLoaderCodeKey:
    Type: String
    Description: "The S3 key for the DataLoaderLambda deployment package"
  UniversitiesCodeKey:
    Type: String
    Description: "The S3 key for the LoadUniversitiesLambda deployment package"
  StepFunctionDefinitionKey:
    Type: String
    Default: "step-function/flow.json"
    Description: "The S3 key for the Step Function definition file"
  ContainerImageURI:
    Type: String
    Description: "URI of the Docker image to use for the ECS Fargate task"
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: "Subnet IDs for ECS tasks"
  SecurityGroupId:
    Type: String
    Description: "Security Group ID for ECS tasks"
  TaskExecutionRoleArn:
    Type: String
    Description: "IAM Role ARN for ECS Task execution"

Resources:
  # Validator Lambda Function
  ValidatorLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: lambda_function.lambda_handler
      Runtime: python3.13
      Role: arn:aws:iam::592789829210:role/service-role/ValidatorLambda-role-vecq9y9u
      Code:
        S3Bucket: !Sub "${CodeBucket}"
        S3Key: !Sub "${ValidatorCodeKey}"
      Timeout: 30
      MemorySize: 128
      Description: "Validator Lambda function deployed via CodePipeline"

  # DataLoader Lambda Function
  DataLoaderLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: lambda_function.lambda_handler
      Runtime: python3.13
      Role: arn:aws:iam::592789829210:role/service-role/ValidatorLambda-role-vecq9y9u
      Code:
        S3Bucket: !Sub "${CodeBucket}"
        S3Key: !Sub "${DataLoaderCodeKey}"
      Timeout: 30
      MemorySize: 128
      Description: "DataLoader Lambda function deployed via CodePipeline"

  # Load Universities Lambda Function
  LoadUniversitiesLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: lambda_function.lambda_handler
      Runtime: python3.13
      Role: arn:aws:iam::592789829210:role/service-role/ValidatorLambda-role-vecq9y9u
      Code:
        S3Bucket: !Sub "${CodeBucket}"
        S3Key: !Sub "${UniversitiesCodeKey}"
      Timeout: 30
      MemorySize: 128
      Description: "Load Universities Lambda function deployed via CodePipeline"

  # ECS Fargate Task Definition
  FargateTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: "aggregate-computation-task"
      Cpu: "256"
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref TaskExecutionRoleArn
      TaskRoleArn: !Ref TaskExecutionRoleArn
      ContainerDefinitions:
        - Name: "aggregate-computation-container"
          Image: !Ref ContainerImageURI
          Cpu: 256
          Memory: 512
          Essential: true
          Command:
            - "python"
            - "aggregate_task.py"
            - "$.country"

  # Step Function
  StateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: MyStepFunction
      DefinitionS3Location:
        Bucket: !Ref CodeBucket
        Key: !Ref StepFunctionDefinitionKey
      RoleArn: arn:aws:iam::592789829210:role/service-role/StepFunctions-MyStateMachine-wtou1f1my-role-47j7sgj16

Outputs:
  ValidatorLambdaFunctionArn:
    Description: "ARN of the Validator Lambda Function"
    Value: !GetAtt ValidatorLambdaFunction.Arn

  DataLoaderLambdaFunctionArn:
    Description: "ARN of the DataLoader Lambda Function"
    Value: !GetAtt DataLoaderLambdaFunction.Arn

  LoadUniversitiesLambdaFunctionArn:
    Description: "ARN of the Load Universities Lambda Function"
    Value: !GetAtt LoadUniversitiesLambdaFunction.Arn

  FargateTaskDefinitionArn:
    Description: "ARN of the ECS Task Definition"
    Value: !Ref FargateTaskDefinition

  StateMachineArn:
    Description: "ARN of the Step Function"
    Value: !GetAtt StateMachine.Arn
